<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>קרב רנדומלי מול שחקן</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { direction: rtl; background-color: #f8f9fa; }
    .battle-container { max-width: 600px; margin: 40px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .result-box { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #e9ecef; }
  </style>
</head>
<body>
  <div class="battle-container">
    <h2 class="text-center mb-4">קרב רנדומלי מול שחקן</h2>

    <div class="mb-3">
      <label for="pokemon-select" class="form-label">בחר פוקימון מהפייבוריטים שלך:</label>
      <select class="form-select" id="pokemon-select">
        <!-- יוזן ב-JS -->
      </select>
    </div>

    <button class="btn btn-primary w-100" onclick="startRandomBattle()">התחל קרב</button>

    <div class="result-box mt-4" id="battle-result" style="display: none;"></div>
  </div>

  <script>
    const userId = localStorage.getItem("userId");
    const favoritesKey = `favorites_${userId}`;
    const rawFavorites = localStorage.getItem(favoritesKey);
    let userFavorites = rawFavorites ? JSON.parse(rawFavorites) : [];

    function loadFavorites() {
      const select = document.getElementById("pokemon-select");
      select.innerHTML = "";

      userFavorites.forEach((poke, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = poke.name || `פוקימון #${index+1}`;
        select.appendChild(option);
      });
    }

    async function startRandomBattle() {
      const idx = document.getElementById("pokemon-select").value;
      const poke = userFavorites[idx];

      // אם אין נתוני סטטיסטיקה – עצור
      if (!poke || !poke.stats) {
        alert("לפוקימון שנבחר אין נתוני סטטיסטיקה (hp, attack וכו') ולכן אי אפשר להתחיל קרב");
        return;
      }

      const battleRes = await fetch("http://localhost:3000/arena/random-vs-player", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, pokemon: {
          name: poke.name,
          hp: poke.stats.hp,
          attack: poke.stats.attack,
          defense: poke.stats.defense,
          speed: poke.stats.speed
        }})
      });

      const result = await battleRes.json();
      displayResult(result);
    }

    function displayResult(data) {
      const box = document.getElementById("battle-result");
      box.innerHTML = `
        <h5>התוצאה:</h5>
        <p><strong>אתה:</strong> ${data.yourScore}</p>
        <p><strong>היריב (${data.opponentName}):</strong> ${data.opponentScore}</p>
        <p><strong>המנצח:</strong> ${data.winner === userId ? 'אתה 🎉' : data.opponentName}</p>
        <hr>
        <h6>פוקימון יריב: ${data.opponentPokemon.name}</h6>
        <ul>
          <li>HP: ${data.opponentPokemon.stats.hp}</li>
          <li>Attack: ${data.opponentPokemon.stats.attack}</li>
          <li>Defense: ${data.opponentPokemon.stats.defense}</li>
          <li>Speed: ${data.opponentPokemon.stats.speed}</li>
        </ul>
      `;
      box.style.display = "block";
    }

    window.onload = loadFavorites;
  </script>
</body>
</html>